# .github/workflows/reusable-review.yml
name: Reusable AI Code Review

on:
  workflow_call:
    inputs:
      dry_run:
        description: "Run without posting comments"
        type: boolean
        default: false
      max_comments:
        description: "Max inline comments"
        type: number
        default: 20
      severity:
        description: "Minimum severity (info, warn, error)"
        type: string
        default: "info"
    secrets:
      github_token:
        required: true
      client_id:
        required: false
      client_secret:
        required: false

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  ai-review:
    name: AI Code Review (Agentic)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout AI Reviewer tool
        uses: actions/checkout@v4
        with:
          repository: shashi-azad/ai-code-reviewer
          path: .ai-pr-reviewer

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --quiet \
            -r .ai-pr-reviewer/scripts/requirements.txt \
            -r .ai-pr-reviewer/model/requirements.txt

      - name: Run Agentic AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.github_token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AI_REVIEW_MAX_COMMENTS: ${{ inputs.max_comments }}
          AI_REVIEW_SEVERITY: ${{ inputs.severity }}
          AI_REVIEW_DRY_RUN: ${{ inputs.dry_run }}
          PYTHONPATH: .ai-pr-reviewer
        run: |
          python .ai-pr-reviewer/runner.py \
            --repo "$GITHUB_REPOSITORY" \
            --pr "$PR_NUMBER" \
            --config .ai-reviewer.json \
            --policy .ai-pr-reviewer/configs/agent_policy.json \
            --templates .ai-pr-reviewer/policies/prompt_templates.json