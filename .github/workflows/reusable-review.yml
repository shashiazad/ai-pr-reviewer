# .github/workflows/reusable-review.yml
name: Reusable AI Code Review

on:
  workflow_call:
    inputs:
      dry_run:
        description: "Run without posting comments"
        type: boolean
        default: false
      max_comments:
        description: "Max inline comments"
        type: number
        default: 20
      severity:
        description: "Minimum severity (info, warn, error)"
        type: string
        default: "info"
    secrets:
      token:
        required: true
      gemini_api_key:
        required: false

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  review:
    name: AI Code Review (Agentic)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout AI Reviewer tool
        uses: actions/checkout@v4
        with:
          repository: shashiazad/ai-pr-reviewer
          path: ai-pr-reviewer    # ← FIXED: matches your repo name

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --quiet \
            -r ai-pr-reviewer/scripts/requirements.txt \
            -r ai-pr-reviewer/model/requirements.txt

      - name: Check Gemini API Key
        if: secrets.gemini_api_key == ''
        run: |
          echo "::error::GEMINI_API_KEY secret is required but not provided."
          echo "::error::Please add a GEMINI_API_KEY secret to your repository settings."
          echo "::error::Get a free API key at: https://aistudio.google.com/app/apikey"
          exit 1

      - name: Run Agentic AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AI_REVIEW_MAX_COMMENTS: ${{ inputs.max_comments }}
          AI_REVIEW_SEVERITY: ${{ inputs.severity }}
          AI_REVIEW_DRY_RUN: ${{ inputs.dry_run }}
          PYTHONPATH: ai-pr-reviewer
        run: |
          cd ai-pr-reviewer    # ← FIXED
          python runner.py \
            --repo "$GITHUB_REPOSITORY" \
            --pr "$PR_NUMBER" \
            --config .ai-reviewer.json \
            --policy configs/agent_policy.json \
            --templates policies/prompt_templates.json